## 自定义标签渲染使用说明（给模型的输出规范）

本说明用于指导模型按约定的“自定义标签”输出，从而在前端触发高级渲染。请严格闭合标签，不要在标签外输出任何多余文字、解释或标点。

### 标签总览
- `status_on` / `status_off`
  - **用途**: 状态栏容器（左对齐标题）。`status_on` 默认展开，`status_off` 默认收起。
  - **属性**: `name`（可选，标题）
  - **内容**: 支持 Markdown（列表、引用、表格、代码块、行内强调等）
- `archive`
  - **用途**: 档案容器（标题居中，默认收起），适合档案表格、属性面板。
  - **属性**: `name`（可选，标题）
  - **内容**: 支持 Markdown（推荐表格）
- `options_h` / `options_v`
  - **用途**: 选项容器（横向/纵向）。用于展示可点选的选项（本地可多选、带选中态）。
  - **属性**: `name`（可选，标题）
  - **内容**: 必须用 `<option>...</option>` 包裹每一项；`<option>` 内支持行内 Markdown（加粗/斜体/删除线/行内代码）
- `notebook`
  - **用途**: 记事本风格容器（内容区带横线背景，默认收起）。
  - **属性**: `name`（可选，标题）
  - **内容**: 支持 Markdown
- `role`
  - **用途**: 角色说话区，左侧显示头像与名字，右侧为对话内容。
  - **属性**: `name`（必填，需与资源映射的 `name` 完全一致才能显示头像）
  - **内容**: 支持 Markdown；可在内部使用 `thought` 标签表示心理活动。
- `thought`（仅在 `role` 内使用）
  - **用途**: 角色心理活动段落（浅色、斜体、点状下划线）。
  - **位置**: 只能出现在 `role` 标签内部。
  - **内容**: 支持 Markdown（建议简短）。

### 共同规则
- **必须闭合**: `<tag name="..."> ... </tag>`
- **标题可选**: 用属性 `name="标题"`；不填会使用默认标题
- **可嵌套**: 支持有限深度（建议不超过 3 层）
- **标签内支持 Markdown**:
  - 行内: `***加粗斜体***`、`**加粗**`、`*斜体*`、`~~删除线~~`、`` `行内代码` ``
  - 块级: `> 引用`、`-`/`*` 列表、表格（`|` 分隔）、代码块（```语言 ... ```）
- **输出洁净**: 不要在标签外输出任何解释、额外文字、标点或多余空行。

### 详细示例与模板

#### 状态栏：`status_on` / `status_off`
- **特性**: 左对齐标题；`status_on` 默认展开、`status_off` 默认折叠
- **适合**: 数值状态、清单、轻量说明

```html
<status_on name="状态栏">
- 生命值：**89%**
- 法力值：**42%**
</status_on>

<status_off name="任务追踪">
> 主线：调查旧城区失踪案
- 线索：工地、纸条、夜行者
</status_off>
```

#### 档案：`archive`（标题居中，默认收起）
- **适合**: 人物档案、装备属性、配点表

```html
<archive name="人物档案">
| 项 | 值 |
| --- | --- |
| 力量 | 7 |
| 智力 | 9 |
| 背景 | 出生于北境的学者 |
</archive>
```

#### 选项：`options_h` / `options_v`（必须使用 `<option>`）
- **特性**: 横向滚动（`options_h`）/ 竖向列表（`options_v`）
- **规则**: 每一项必须放在 `<option>...</option>` 中；`<option>` 内仅使用行内 Markdown
- **建议**: 同一消息中标题尽量唯一（容器的 groupId = 标题 + 容器类型）

```html
<options_h name="行动选择">
  <option>侦查周边</option>
  <option>与守卫交谈</option>
  <option>直接潜入</option>
</options_h>

<options_v name="对话选项">
  <option>“我来自北境。”</option>
  <option>“只是路过。”</option>
  <option>保持沉默</option>
</options_v>
```

#### 记事本：`notebook`（记事本风格，默认收起）
- **适合**: 临时线索、任务笔记、想法备忘

```html
<notebook name="线索笔记">
- 工地夜间有人影出没
- 纸条上有蓝色粉末
- “夜行者”或为组织代号
</notebook>
```

#### 角色：`role`（带头像与名字的对话区）
- **必填**: `name="角色名"`（需与资源映射一致才能显示头像）
- **内部可用**: `<thought>...</thought>` 插入心理活动段（特殊样式，勿加引号）
- **适合**: 角色台词、叙述、内心独白

```html
<role name="艾琳">
昨晚的风很冷，我在码头看见微弱的灯。

<thought>他似乎隐瞒了什么，但现在还不能追问。</thought>

“把你知道的都告诉我，我会保密的。”
</role>
```

#### 心理活动：`thought`（仅 `role` 内）
- **用法**: 作为 `role` 内的特殊段落，无需引号，自动套用心理活动样式

```html
<role name="艾琳">
<thought>必须稳住他的情绪，先让信息流动起来。</thought>
“先去工地。”
</role>
```

### 头像资源映射（用于 `role` 头像显示）
- **映射字符串格式（每行一个资源）**: `<name="角色名"|uri="图片URI">`
- **匹配规则**: 只有当 `role` 的 `name` 与映射中的 `name` 完全一致时，才会显示头像
- **示例**:

```
<name="艾琳"|uri="https://example.com/images/elin.png">
<name="局长"|uri="https://example.com/images/chief.jpg">
```

- **备注**: URI 可为网络地址或后端文件服务可访问的路径；若无匹配或加载失败，则显示占位样式或首字母。

### 推荐的综合输出结构（示例）

```html
<status_on name="状态栏">
- 体力：**78%**
- 心情：*平静*
</status_on>

<archive name="案件档案">
| 项 | 值 |
| --- | --- |
| 案号 | A-17 |
| 地点 | 旧城区 |
| 备注 | 夜间行动风险较高 |
</archive>

<options_h name="行动选择">
  <option>前往工地调查</option>
  <option>回报线索给局长</option>
  <option>夜间蹲守</option>
</options_h>

<notebook name="临时笔记">
- 工地有未登记出入记录
- 夜行者或许不是个人
</notebook>

<role name="艾琳">
“这次我不会再退缩。”
<thought>如果他们在说谎，今晚就会露出破绽。</thought>
“先去工地。”
</role>
```

### 可直接放进模型系统/角色设定的约束片段
- 仅使用以下自定义标签输出内容：`status_on`、`status_off`、`archive`、`options_h`、`options_v`、`notebook`、`role`，并且必须成对闭合。
- 如需标题，用属性 `name="标题"`。
- 在 `options_h`/`options_v` 中，所有选项必须放在 `<option>...</option>` 中；`<option>` 内仅使用行内 Markdown。
- 在 `role` 内可插入 `<thought>...</thought>` 表示心理活动（无引号，不要再包容器）。
- 标签可嵌套但不超过 3 层。
- 标签内可使用 Markdown（列表、引用、表格、代码块等）。
- 角色名必须与资源映射中的 `name` 一致才能显示头像。
- 不要在标签外输出任何解释、额外文字、标点或多余空行。

### 常见错误与避免
- 未闭合标签或写错标签名（务必与上述标签一致）。
- 在选项容器中未使用 `<option>` 包裹每一项。
- 在 `role` 中缺少 `name` 属性或与资源映射不一致。
- 在 `<option>` 内写多段块级结构（请仅用行内 Markdown）。
- 输出标签外多余文字、提示或标点。
- 过度嵌套导致结构可读性差（建议 ≤ 3 层）。

---

### 给普通用户的超简使用指南（看这个就够了）

- 我想显示“状态/小面板”：
  - 用 `status_on`（默认展开）或 `status_off`（默认收起）
  - 在设定里面告诉模型，状态栏之类的以这个形式输出即可：
    ```html
    <status_on name="状态栏">
    - 生命值：**89%**
    - 法力值：**42%**
    </status_on>
    ```

- 我想给读者几个“按钮选项”让他点：
  - 横向滚动用 `options_h`，竖向列表用 `options_v`
  - 每个选项必须写在 `<option>这里是选项文字</option>` 里
  - 在设定里面告诉模型，选项列表以这个形式输出即可：
    ```html
    <options_v name="对话选项">
      <option>“我来自北境。”</option>
      <option>“只是路过。”</option>
      <option>保持沉默</option>
    </options_v>
    ```
  - 当大模型按照这个格式输出时，就会渲染出一个竖向列表出来，包含三个按钮“我来自北境”、“只是路过”和“保持沉默”。


- 让某个角色说话的时候好看些（还能显示头像）：
  - 用 `role`，必须写名字：`name="角色名"`
  - 内心独白用 `<thought>这里是心理活动</thought>` 放在 `role` 里面
  - 在设定里面告诉模型，当角色说话的时候以这个形式输出即可：
    ```html
    <role name="艾琳">
    “先去工地。”
    <thought>别把他们逼太紧。</thought>
    </role>
    ```
  - 想显示头像？请在“资源映射”里配置：
    ```
    <name="艾琳"|uri="https://example.com/elin.png">
    ```
    角色名必须和 `role` 的 `name` 一模一样。

- 我想放“表格档案”：
  - 用 `archive`，里面直接用 Markdown 表格（用 `|` 分列）
  - 在设定里面告诉模型，以这个形式输出即可：
    ```html
    <archive name="人物档案">
    | 项 | 值 |
    | --- | --- |
    | 力量 | 7 |
    | 智力 | 9 |
    </archive>
    ```

- 我想记“横线笔记本”：
  - 用 `notebook`，里面按行写条目
  - 在设定里面告诉模型，以这个形式输出即可：
    ```html
    <notebook name="线索笔记">
    - 工地夜间有人影
    - 纸条上有蓝色粉末
    </notebook>
    ```

- 三条铁律（最容易踩坑）：
  - 所有标签都要“成对闭合”，比如 `<role>...</role>`。
  - 选项容器里，选项必须写在 `<option>...</option>` 里。
  - 不要在标签外面写解释或多余内容（只输出标签本身）。

- 一段最小可用角色设定示例（可直接复制）：
  ```html
  我希望状态栏以这种格式展示：
  <status_on name="状态栏">
  - 体力：**78%**
  </status_on>

  选项以这种格式展示：
  <options_h name="行动选择">
    <option>前往工地调查</option>
    <option>回报线索</option>
  </options_h>

  当对应角色说话时，以这种格式展示：
  <role name="艾琳">
  “这次我不会再退缩。”
  <thought>先稳住他们的情绪。</thought>
  </role>
  ```

你的职责：作为创作/设定向的交互教练，优先“指导用户如何做”，仅在用户明确要求时，才输出用于前端渲染的“自定义标签内容”。

【工作模式】
- 指导模式（默认）：用自然中文，分步骤引导、提问澄清、给出建议与范例。展示范例时，用转义的标签（[...];）避免触发渲染。
- 渲染模式（仅在用户确认后）：只输出真正的渲染标签，不要有任何解释文字或空行。严格符合标签规范。

【渲染标签规范（供你参考，指导时不要直接输出原样标签）】
- 可用标签：status_on、status_off、archive、options_h、options_v、notebook、role（以及 role 内的 thought）
- 闭合：必须成对闭合；可选属性：name="标题"
- 嵌套：最多 3 层
- Markdown 支持（标签内）：行内（***加粗斜体***、**加粗**、*斜体*、~~删除线~~、`行内代码`），块级（> 引用、-/* 列表、以 | 开头的表格、``` 代码块）
- 选项容器（options_h/options_v）：每一项必须写成 <option>内容</option>，且仅使用“行内”Markdown
- role：必须写 name="角色名"；头像依赖外部资源映射（<name="角色名"|uri="图片URI">），名字需完全一致
- 禁止：未知标签、缺少闭合、在 <option> 内放表格/引用/代码块、标签外多余文字

【如何指导用户（流程与话术）】
1) 快速澄清需求（简短提问）
   - 角色名/称呼？是否需要头像？
   - 需要哪些“状态项”或“任务追踪”？
   - 是否给用户几个“下一步选项”？横向还是竖向？
   - 是否需要“档案表格”或“记事本”来整理信息？
   - 需要角色台词/叙述吗？是否包含心理活动（thought）？

2) 给出建议结构（用清单+简短解释）
   - 建议块：状态栏（简要状态）/ 选项（下一步操作）/ 档案（表格）/ 记事本（临时笔记）/ 角色（台词+心理活动）

3) 提供可复制范例（用“转义后的标签”演示，不触发渲染）
   - 示例一：状态栏
     <status_on name="状态栏">
     - 体力：**78%**
     - 心情：*平静*
     </status_on>

   - 示例二：竖向选项
     <options_v name="对话选项">
       <option>“我来自北境。”&</option>
       <option>“只是路过。”</option>
       <option>保持沉默</option>
     </options_v>
     （渲染后会出现三枚可点按钮）

   - 示例三：角色发言+心理活动
     <role name="艾琳">
     “先去工地。”
     <thought>别把他们逼太紧。</thought>
     </role>

   - 示例四：档案（表格）
     <archive name="人物档案">
     | 项 | 值 |
     | --- | --- |
     | 力量 | 7 |
     | 智力 | 9 |
     </archive>

   - 示例五：记事本
     <notebook name="线索笔记">
     - 工地夜间有人影
     - 纸条有蓝色粉末
     </notebook>

4) 资源映射提示（若用户要头像）
   - 说明头像显示依赖外部映射。需要在角色卡的设定中添加资源映射

5) 确认输出模式
   - 若用户说“生成/预览最终内容/请直接渲染”：进入“渲染模式”，只输出标签，不加说明。
   - 若用户仍在讨论或想要教程：保持“指导模式”，继续用转义标签举例并优化内容。

【渲染模式硬性约束（触发后严格执行）】
- 只输出标签块，不得包含任何额外文字、标点、前后缀或空行
- 标签闭合正确；options_* 使用 <option>；不超过 3 层嵌套
- 需要多个块时，直接顺序输出多个标签块

【示例对话策略】
- 用户：我想让“艾琳”说话并给三个行动选项。
- 你（指导模式）：简短提问补充（如：选项横向/竖向？是否加一条状态栏？是否添加心理活动？）
- 你（提供转义范例）：给出 [role]、[options_v] 的转义版本让用户确认
- 用户：确认无误，请直接渲染
- 你（渲染模式）：仅输出真实标签（无解释）

【口吻与格式】
- 简明、礼貌、面向非技术用户；用要点/小清单说明
- 默认指导模式，除非用户明确要求渲染

---

## 🎨 颜色自定义支持（新增功能）

### 功能概述
所有自定义标签现在支持完全的颜色自定义，包括背景色、文字色和透明度设置。用户可以通过聊天设置界面为每种标签类型配置独特的视觉样式。

### 支持的标签类型与样式键名
| 标签类型 | 样式键名 | 说明 |
|---------|---------|------|
| `role` | `role` | 角色对话标签 |
| `message` | `message` | 消息标签 |
| `topic` | `topic` | 话题标签（包含评论系统） |
| `feed` | `feed` | 信息流标签 |
| `chat-list` | `chat-list` | 聊天列表标签 |
| `chat-conversation` | `chat-conversation` | 对话界面标签 |
| `options_h` | `options_h` | 水平选项标签 |
| `options_v` | `options_v` | 垂直选项标签 |
| `notebook` | `notebook` | 笔记本标签 |
| `status_on` | `status_on` | 展开状态栏标签 |
| `status_off` | `status_off` | 折叠状态栏标签 |
| `archive` | `archive` | 档案标签 |

### 颜色配置参数
每种标签样式支持以下三个参数：
- **backgroundColor**: 背景颜色（16进制格式，如 0xFF2196F3）
- **opacity**: 透明度（0.0-1.0之间的小数）
- **textColor**: 文字颜色（16进制格式，如 0xFF000000）

### 配色规则
为了保持视觉一致性和可读性，所有标签遵循统一的配色规则：

#### 标题栏元素（跟随背景色）
- 图标（如记事本图标、聊天图标等）
- 标题文字
- 操作按钮（如折叠按钮、搜索按钮等）
- 边框和分隔线

#### 内容文字（跟随文字色）
- 正文内容
- 角色名字
- 消息文本
- 评论内容
- 选项文字（未选中状态会有透明度变化）

#### 装饰元素（背景色的透明度变化）
- 容器背景渐变
- 边框颜色
- 分隔线
- 气泡背景

### 实际效果示例
当用户为`role`标签配置：
- backgroundColor: 蓝色 (0xFF2196F3)
- opacity: 0.3
- textColor: 深蓝色 (0xFF1565C0)

渲染效果：
- 角色头像边框：蓝色
- 角色名字：深蓝色
- 对话内容：深蓝色
- 容器背景：蓝色渐变（不同透明度层次）

### 技术实现
- 使用`ChatSettingsDao().getCustomTagStyles()`异步获取样式配置
- 每个标签组件内部使用`FutureBuilder`动态应用样式
- 支持实时样式更新，无需重启应用
- 向下兼容：未配置自定义样式时使用默认的baseStyle

### 使用建议
1. **主题一致性**: 建议为相关标签使用相近的颜色搭配
2. **对比度**: 确保文字色与背景色有足够的对比度以保证可读性
3. **透明度**: 建议opacity值在0.1-0.5之间，过高可能影响可读性
4. **色彩搭配**: 可以为不同功能的标签使用不同色系（如状态用绿色，警告用橙色等）

这个颜色自定义系统让用户能够创建完全个性化的聊天界面，每种标签都能完美融入用户的个人审美偏好。🎨✨

---

## 📱 新增标签类型说明

### 消息类标签

#### `message` - 通用消息标签
- **用途**: 显示各种类型的消息内容，支持左右对齐
- **属性**:
  - `name`（可选，发送者名称）
  - `side`（可选，`left`或`right`，默认`left`）
- **特性**:
  - 支持嵌入式角色名显示
  - 自适应气泡样式
  - 支持Markdown格式化

```html
<message name="系统通知" side="left">
**重要提醒**: 您的账户安全等级已提升。
</message>

<message name="用户反馈" side="right">
感谢提醒！这个功能很实用。
</message>
```

#### `chat-list` - 聊天列表标签
- **用途**: 模拟微信等聊天应用的聊天列表界面
- **属性**: `title`（可选，应用名称，如"微信"）
- **内容**: 使用`<chat-item>`子标签定义每个聊天项
- **子标签属性**:
  - `name`（必填，联系人名称）
  - `lastMsg`（可选，最后消息内容）
  - `time`（可选，最后消息时间）
  - `unread`（可选，未读消息数）
  - `status`（可选，在线状态：online/offline）
  - `type`（可选，类型：group表示群聊）

```html
<chat-list title="微信">
<chat-item name="张三" lastMsg="你好吗？" time="10:30" unread="2" status="online">好友</chat-item>
<chat-item name="李四" lastMsg="在忙什么" time="昨天" unread="0" status="offline">同事</chat-item>
<chat-item name="工作群" lastMsg="明天开会" time="09:15" unread="5" type="group">群聊</chat-item>
</chat-list>
```

#### `chat-conversation` - 对话界面标签
- **用途**: 模拟聊天应用的对话界面
- **属性**: `title`（可选，对话标题）
- **内容**: 使用`<chat-msg>`子标签定义每条消息
- **子标签属性**:
  - `sender`（必填，发送者名称）
  - `time`（可选，发送时间）
  - `side`（可选，`left`或`right`）

```html
<chat-conversation title="与张三的对话">
<chat-msg sender="张三" time="10:25" side="left">你好！</chat-msg>
<chat-msg sender="我" time="10:26" side="right">你好，最近怎么样？</chat-msg>
<chat-msg sender="张三" time="10:27" side="left">挺好的，工作很忙</chat-msg>
</chat-conversation>
```

### 内容展示类标签

#### `feed` - 信息流标签
- **用途**: 展示类似社交媒体的信息流内容
- **属性**: `title`（可选，信息流标题）
- **内容**: 使用`<topic>`子标签定义每个话题项
- **特性**:
  - 紧凑的列表式布局
  - 支持话题预览
  - 显示互动数据（点赞、评论数）

```html
<feed title="我的动态">
<topic title="话题1" author="张三" time="2小时前" tags="科技" likes="15" shares="3" comments="5">内容1</topic>
<topic title="话题2" author="李四" time="1小时前" tags="生活" likes="8" shares="1" comments="2">内容2</topic>
</feed>
```

### 扩展功能

#### 话题评论系统
`topic`标签支持嵌套评论系统，使用`<comments>`和`<comment>`子标签：

```html
<topic title="技术讨论" author="张三" time="2小时前" tags="AI,技术,编程" likes="25" shares="5" comments="8">
# AI技术的未来发展
人工智能技术正在快速发展，特别是在自然语言处理领域取得了重大突破。

<comments>
<comment author="李四" time="1小时前" likes="5">非常同意！AI的发展确实令人惊叹。</comment>
<comment author="王五" time="30分钟前" likes="3">期待看到更多实际应用场景。</comment>
</comments>
</topic>
```

### 新增标签的使用场景

#### 适用场景建议
- **`message`**: 系统通知、用户反馈、重要消息
- **`chat-list`**: 展示聊天应用界面、联系人列表
- **`chat-conversation`**: 模拟对话过程、展示聊天记录
- **`feed`**: 社交动态、新闻列表、内容推荐

#### 组合使用示例
```html
<status_on name="在线状态">
- 当前用户：**小艾**
- 在线时长：**2小时15分钟**
</status_on>

<chat-list title="最近聊天">
<chat-item name="技术交流群" lastMsg="有人在吗？想讨论一个技术问题" time="刚刚" unread="3" type="group">群聊</chat-item>
<chat-item name="项目组" lastMsg="今天的进度汇报已发送" time="5分钟前" unread="0" status="online">同事</chat-item>
</chat-list>

<options_v name="快速操作">
<option>查看未读消息</option>
<option>发起新对话</option>
<option>查看群聊列表</option>
</options_v>
```

这些新增标签大大丰富了内容展示的可能性，结合颜色自定义功能，可以创造出极具个性化的聊天体验。